jQuery(function(e){e.widget("blueimp.fileupload",e.blueimp.fileupload,{options:{imageMaxWidth:Joomla.getOptions("com_kunena.imagewidth"),imageMaxHeight:Joomla.getOptions("com_kunena.imageheight")}});function c(i,h,j){var k=e("#editor").val();e("#editor").insertAtCaret(" [attachment="+i+"]"+h+"[/attachment]");if(j!==undefined){j.removeClass("btn-primary");j.addClass("btn-success");j.html(Joomla.getOptions("com_kunena.icons.upload")+" "+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));}}jQuery.fn.extend({insertAtCaret:function(h){return this.each(function(l){if(document.selection){this.focus();sel=document.selection.createRange();sel.text=h;this.focus();}else{if(this.selectionStart||this.selectionStart==="0"){var k=this.selectionStart;var j=this.selectionEnd;var m=this.scrollTop;this.value=this.value.substring(0,k)+h+this.value.substring(j,this.value.length);this.focus();this.selectionStart=k+h.length;this.selectionEnd=k+h.length;this.scrollTop=m;}else{this.value+=h;this.focus();}}});}});var g=null;var b=null;e("#remove-all").on("click",function(h){h.preventDefault();e("#progress").hide();e("#insert-all").removeClass("btn-success");e("#insert-all").addClass("btn-primary");e("#insert-all").html(Joomla.getOptions("com_kunena.icons.delete")+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_INSERT_ALL_BUTTON"));e("#remove-all").hide();e("#insert-all").hide();if(e.isEmptyObject(b)===false){e(b).each(function(j,k){if(e("#kattachs-"+k.id).length===0){e("#kattach-list").append('<input id="kattachs-'+k.id+'" type="hidden" name="attachments['+k.id+']" value="1" />');}if(e("#kattach-"+k.id).length>0){e("#kattach-"+k.id).remove();}e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&file_id="+k.id,type:"POST"}).done(function(l){e("#files").empty();}).fail(function(){});});b=null;}var i=e("#kattach-list").find("input");i.each(function(j,k){var l=e(k);if(!l.attr("id").match("[a-z]{8}")){var m=l.attr("id").match("[0-9]{2}");if(e("#kattachs-"+m).length===0){e("#kattach-list").append('<input id="kattachs-'+m+'" type="hidden" name="attachments['+m+']" value="1" />');}if(e("#kattach-"+m).length>0){e("#kattach-"+m).remove();}e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&file_id="+m,type:"POST"}).done(function(n){e("#files").empty();}).fail(function(){});}});e("#alert_max_file").remove();g=0;});e("#insert-all").on("click",function(h){h.preventDefault();if(e.isEmptyObject(b)===false){e(b).each(function(k,l){c(l.id,l.name);});}b=null;var j=e("#kattach-list").find("input");var i=[];j.each(function(m,n){var o=e(n);if(!o.attr("id").match("[a-z]{8}")){var l=o.attr("id").match("[0-9]{1,8}");var k=o.attr("placeholder");c(l,k);e("#insert-all").removeClass("btn-primary");e("#insert-all").addClass("btn-success");e("#insert-all").html(Joomla.getOptions("com_kunena.icons.upload")+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));i.push(l);}});e("#files .btn.btn-primary").each(function(){e("#files .btn.btn-primary").addClass("btn-success");e("#files .btn.btn-success").removeClass("btn-primary");e("#files .btn.btn-success").html(Joomla.getOptions("com_kunena.icons.upload")+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));});e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem_inline")+"&files_id="+i,type:"POST"}).done(function(k){}).fail(function(){});});var a=e("<button>").addClass("btn btn-primary").html(Joomla.getOptions("com_kunena.icons.upload")+" "+Joomla.JText._("COM_KUNENA_EDITOR_INSERT")).on("click",function(l){l.preventDefault();l.stopPropagation();var k=e(this),j=k.data();var i=0;var h=null;if(j.result!==undefined){i=j.result.data.id;h=j.result.data.filename;}else{i=j.id;h=j.name;}c(i,h,k);e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem_inline")+"&file_id="+i,type:"POST"}).done(function(m){m.inline=1;e("#removeInline").show();}).fail(function(){});});var f=e("<button>").addClass("btn btn-primary").attr("id","removeInline").html(Joomla.getOptions("com_kunena.icons.trash")+" "+Joomla.JText._("COM_KUNENA_EDITOR_REMOVE_INLINE")).on("click",function(l){l.preventDefault();l.stopPropagation();var k=e(this),j=k.data();var i=0;if(j.uploaded===true){if(j.result!==false){i=j.result.data.id;}else{i=j.file_id;}}var h=e("#editor").val();e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem_inline")+"&file_id="+i+"&editor_text="+h,type:"POST"}).done(function(m){m.inline=0;k.hide();e("#editor").val(m.text_prepared);}).fail(function(){});});var d=e("<button/>").addClass("btn btn-danger").attr("type","button").html(Joomla.getOptions("com_kunena.icons.trash")+" "+Joomla.JText._("COM_KUNENA_GEN_REMOVE_FILE")).on("click",function(l){l.preventDefault();l.stopPropagation();var k=e(this),j=k.data();e("#klabel_info_drop_browse").show();var i=0;if(j.uploaded===true){if(j.result!==false){i=j.result.data.id;}else{i=j.file_id;}}if(e("#kattachs-"+i).length===0){e("#kattach-list").append('<input id="kattachs-'+i+'" type="hidden" name="attachments['+i+']" value="1" />');}if(e("#kattach-"+i).length>0){e("#kattach-"+i).remove();}g=g-1;e("#alert_max_file").remove();var h=e("#editor").val();e.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&file_id="+i+"&editor_text="+h,type:"POST"}).done(function(m){k.parent().remove();e("#editor").val(m.text_prepared);}).fail(function(){});});e("#fileupload").fileupload({url:e("#kunena_upload_files_url").val(),dataType:"json",autoUpload:true,disableImageResize:/ Android( ?!.*Chrome) |Opera /.test(window.navigator.userAgent),previewMaxWidth:100,previewMaxHeight:100,previewCrop:true}).bind("fileuploadsubmit",function(i,h){var j={};e.each(h.files,function(k,l){j={catid:e("#kunena_upload").val(),filename:l.name,size:l.size,mime:l.type};});h.formData=j;}).bind("fileuploaddrop",function(j,i){e("#form_submit_button").prop("disabled",true);e("#progress").css("display","block");e("#remove-all").show();e("#insert-all").show();e("#kattach_form").show();var h=Object.keys(i.files).length+g;if(h>Joomla.getOptions("com_kunena.kunena_upload_files_maxfiles")){e('<div class="alert alert-danger" id="alert_max_file"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(e("#files"));e("#form_submit_button").prop("disabled",false);return false;}else{g=Object.keys(i.files).length+g;}}).bind("fileuploadchange",function(j,i){e("#form_submit_button").prop("disabled",true);e("#remove-all").show();e("#insert-all").show();var h=Object.keys(i.files).length+g;if(h>Joomla.getOptions("com_kunena.kunena_upload_files_maxfiles")){e('<div class="alert alert-danger" id="alert_max_file"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(e("#files"));e("#form_submit_button").prop("disabled",false);return false;}else{g=Object.keys(i.files).length+g;}}).on("fileuploadadd",function(i,h){e("#progress .bar").css("width","0%");e("#progress").css("display","block");h.context=e("<div/>").appendTo("#files");e.each(h.files,function(j,k){var l=e("<p/>").append(e("<span/>").text(k.name));if(!j){l.append("<br>");}l.appendTo(h.context);});}).on("fileuploadprocessalways",function(l,k){var h=k.index,i=k.files[h],j=e(k.context.children()[h]);if(i.preview){j.prepend("<br>").prepend(i.preview);}if(i.error){j.append("<br>").append(e('<span class="text-danger"/>').text(i.error));}if(h+1===k.files.length){k.context.find("button.btn-primary").text(Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_UPLOAD_BUTTON")).prop("disabled",!!k.files.error);}}).on("fileuploaddone",function(l,k){var i=parseInt(k.loaded/k.total*100,10);e("#progress .bar").css("width",i+"%");var j=e("<a>").attr("target","_blank").prop("href",k.result.location);k.context.find("span").wrap(j);if(k.result.success===true){e("#form_submit_button").prop("disabled",false);e("#kattach-list").append('<input id="kattachs-'+k.result.data.id+'" type="hidden" name="attachments['+k.result.data.id+']" value="1" />');e("#kattach-list").append('<input id="kattach-'+k.result.data.id+'" placeholder="'+k.result.data.filename+'" type="hidden" name="attachment['+k.result.data.id+']" value="1" />');k.uploaded=true;k.context.append(a.clone(true).data(k));if(k.context.find("button").hasClass("btn-danger")){k.context.find("button.btn-danger").remove();}k.context.append(d.clone(true).data(k));if(k.inline){k.context.append(f.clone(true).data(k));}}else{if(k.result.message){e("#form_submit_button").prop("disabled",false);k.uploaded=false;k.context.append(d.clone(true).data(k));var h=null;e.each(k.result.data.exceptions,function(n,m){m=e('<div class="alert alert-error"/>').text(m.message);k.context.find("span").append("<br>").append(m);});}}}).on("fileuploadfail",function(i,h){e.each(h.files,function(k,l){var j=e('<span class="text-danger"/>').text(l.error);e(h.context.children()[k]).append("<br>").append(j);});}).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?undefined:"disabled");if(e("#kmessageid").val()>0){e.ajax({type:"POST",url:Joomla.getOptions("com_kunena.kunena_upload_files_preload"),async:true,dataType:"json",data:{mes_id:e("#kmessageid").val()}}).done(function(h){if(e.isEmptyObject(h.files)===false){g=Object.keys(h.files).length;b=h.files;e(h.files).each(function(j,k){var l="";if(k.image===true){l='<img src="'+k.path+'" width="100" height="100" /><br />';}else{l=Joomla.getOptions("com_kunena.icons.attach")+" <br />";}var i=e("<div><p>"+l+"<span>"+k.name+"</span><br /></p></div>");h.uploaded=true;h.result=false;h.file_id=k.id;i.append(a.clone(true).data(k));i.append(d.clone(true).data(h));if(k.inline===true){i.append(f.clone(true).data(h));}i.appendTo("#files");});}}).fail(function(){});}});