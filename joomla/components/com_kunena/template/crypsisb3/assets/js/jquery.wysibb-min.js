/*! WysiBB v1.5.1 2014-03-26
    Author: Vadim Dobroskok
 */
;if(typeof(WBBLANG)=="undefined"){WBBLANG={};}WBBLANG.en=CURLANG={bold:"Bold",italic:"Italic",underline:"Underline",strike:"Strike",link:"Link",img:"Insert image",sup:"Superscript",sub:"Subscript",justifyleft:"Align left",justifycenter:"Align center",justifyright:"Align right",table:"Insert table",bullist:"â€¢ Unordered list",numlist:"1. Ordered list",quote:"Quote",offtop:"Offtop",code:"Code",spoiler:"Spoiler",fontcolor:"Font color",fontsize:"Font size",fontfamily:"Font family",fs_verysmall:"Very small",fs_small:"Small",fs_normal:"Normal",fs_big:"Big",fs_verybig:"Very big",smilebox:"Insert emoticon",video:"Insert YouTube",removeFormat:"Remove Format",modal_link_title:"Insert link",modal_link_text:"Display text",modal_link_url:"URL",modal_email_text:"Display email",modal_email_url:"Email",modal_link_tab1:"Insert URL",modal_img_title:"Insert image",modal_img_tab1:"Insert URL",modal_img_tab2:"Upload image",modal_imgsrc_text:"Enter image URL",modal_img_btn:"Choose file",add_attach:"Add Attachment",modal_video_text:"Enter the URL of the video",close:"Close",save:"Save",cancel:"Cancel",remove:"Delete",validation_err:"The entered data is invalid",error_onupload:"Error during file upload",fileupload_text1:"Drop file here",fileupload_text2:"or",loading:"Loading",auto:"Auto",views:"Views",downloads:"Downloads",sm1:"Smile",sm2:"Laughter",sm3:"Wink",sm4:"Thank you",sm5:"Scold",sm6:"Shock",sm7:"Angry",sm8:"Pain",sm9:"Sick"};wbbdebug=false;(function(a){a.wysibb=function(c,b){a(c).data("wbb",this);if(b&&b.deflang&&typeof(WBBLANG[b.deflang])!="undefined"){CURLANG=WBBLANG[b.deflang];}if(b&&b.lang&&typeof(WBBLANG[b.lang])!="undefined"){CURLANG=WBBLANG[b.lang];}this.txtArea=c;this.$txtArea=a(c);var d=this.$txtArea.attr("id")||this.setUID(this.txtArea);this.options={bbmode:false,onlyBBmode:false,themeName:"default",bodyClass:"",lang:"ru",tabInsert:true,imgupload:false,img_uploadurl:"/iupload.php",img_maxwidth:800,img_maxheight:800,hotkeys:true,showHotkeys:true,autoresize:true,resize_maxheight:800,loadPageStyles:true,traceTextarea:true,smileConversion:true,buttons:"bold,italic,underline,strike,sup,sub,|,img,video,link,|,bullist,numlist,|,fontcolor,fontsize,fontfamily,|,justifyleft,justifycenter,justifyright,|,quote,code,table,removeFormat",allButtons:{bold:{title:CURLANG.bold,buttonHTML:'<span class="fonticon ve-tlb-bold1">\uE018</span>',excmd:"bold",hotkey:"ctrl+b",transform:{"<b>{SELTEXT}</b>":"[b]{SELTEXT}[/b]","<strong>{SELTEXT}</strong>":"[b]{SELTEXT}[/b]"}},italic:{title:CURLANG.italic,buttonHTML:'<span class="fonticon ve-tlb-italic1">\uE001</span>',excmd:"italic",hotkey:"ctrl+i",transform:{"<i>{SELTEXT}</i>":"[i]{SELTEXT}[/i]","<em>{SELTEXT}</em>":"[i]{SELTEXT}[/i]"}},underline:{title:CURLANG.underline,buttonHTML:'<span class="fonticon ve-tlb-underline1">\uE002</span>',excmd:"underline",hotkey:"ctrl+u",transform:{"<u>{SELTEXT}</u>":"[u]{SELTEXT}[/u]"}},strike:{title:CURLANG.strike,buttonHTML:'<span class="fonticon fi-stroke1 ve-tlb-strike1">\uE003</span>',excmd:"strikeThrough",transform:{"<strike>{SELTEXT}</strike>":"[s]{SELTEXT}[/s]","<s>{SELTEXT}</s>":"[s]{SELTEXT}[/s]"}},sup:{title:CURLANG.sup,buttonHTML:'<span class="fonticon ve-tlb-sup1">\uE005</span>',excmd:"superscript",transform:{"<sup>{SELTEXT}</sup>":"[sup]{SELTEXT}[/sup]"}},sub:{title:CURLANG.sub,buttonHTML:'<span class="fonticon ve-tlb-sub1">\uE004</span>',excmd:"subscript",transform:{"<sub>{SELTEXT}</sub>":"[sub]{SELTEXT}[/sub]"}},link:{title:CURLANG.link,buttonHTML:'<span class="fonticon ve-tlb-link1">\uE007</span>',hotkey:"ctrl+shift+2",modal:{title:CURLANG.modal_link_title,width:"500px",tabs:[{input:[{param:"SELTEXT",title:CURLANG.modal_link_text,type:"div"},{param:"URL",title:CURLANG.modal_link_url,validation:"^http(s)?://"}]}]},transform:{'<a href="{URL}">{SELTEXT}</a>':"[url={URL}]{SELTEXT}[/url]",'<a href="{URL}">{URL}</a>':"[url]{URL}[/url]"}},img:{title:CURLANG.img,buttonHTML:'<span class="fonticon ve-tlb-img1">\uE006</span>',hotkey:"ctrl+shift+1",addWrap:true,modal:{title:CURLANG.modal_img_title,width:"600px",tabs:[{title:CURLANG.modal_img_tab1,input:[{param:"SRC",title:CURLANG.modal_imgsrc_text,validation:"^http(s)?://.*?.(jpg|png|gif|jpeg)$"}]}],onLoad:this.imgLoadModal},transform:{'<img src="{SRC}" />':"[img]{SRC}[/img]",'<img src="{SRC}" width="{WIDTH}" height="{HEIGHT}"/>':"[img width={WIDTH},height={HEIGHT}]{SRC}[/img]"}},bullist:{title:CURLANG.bullist,buttonHTML:'<span class="fonticon ve-tlb-list1">\uE009</span>',excmd:"insertUnorderedList",transform:{"<ul>{SELTEXT}</ul>":"[list]{SELTEXT}[/list]","<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},numlist:{title:CURLANG.numlist,buttonHTML:'<span class="fonticon ve-tlb-numlist1">\uE00a</span>',excmd:"insertOrderedList",transform:{"<ol>{SELTEXT}</ol>":"[list=1]{SELTEXT}[/list]","<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},quote:{title:CURLANG.quote,buttonHTML:'<span class="fonticon ve-tlb-quote1">\uE00c</span>',hotkey:"ctrl+shift+3",transform:{"<blockquote>{SELTEXT}</blockquote>":"[quote]{SELTEXT}[/quote]"}},code:{title:CURLANG.code,buttonText:"[code]",hotkey:"ctrl+shift+4",onlyClearText:true,transform:{"<code>{SELTEXT}</code>":"[code]{SELTEXT}[/code]"}},offtop:{title:CURLANG.offtop,buttonText:"offtop",transform:{'<span style="font-size:10px;color:#ccc">{SELTEXT}</span>':"[offtop]{SELTEXT}[/offtop]"}},fontcolor:{type:"colorpicker",title:CURLANG.fontcolor,excmd:"foreColor",valueBBname:"color",subInsert:true,colors:"#000000,#444444,#666666,#999999,#b6b6b6,#cccccc,#d8d8d8,#efefef,#f4f4f4,#ffffff,-, 							 #ff0000,#980000,#ff7700,#ffff00,#00ff00,#00ffff,#1e84cc,#0000ff,#9900ff,#ff00ff,-, 							 #f4cccc,#dbb0a7,#fce5cd,#fff2cc,#d9ead3,#d0e0e3,#c9daf8,#cfe2f3,#d9d2e9,#ead1dc, 							 #ea9999,#dd7e6b,#f9cb9c,#ffe599,#b6d7a8,#a2c4c9,#a4c2f4,#9fc5e8,#b4a7d6,#d5a6bd, 							 #e06666,#cc4125,#f6b26b,#ffd966,#93c47d,#76a5af,#6d9eeb,#6fa8dc,#8e7cc3,#c27ba0, 							 #cc0000,#a61c00,#e69138,#f1c232,#6aa84f,#45818e,#3c78d8,#3d85c6,#674ea7,#a64d79, 							 #900000,#85200C,#B45F06,#BF9000,#38761D,#134F5C,#1155Cc,#0B5394,#351C75,#741B47, 							 #660000,#5B0F00,#783F04,#7F6000,#274E13,#0C343D,#1C4587,#073763,#20124D,#4C1130",transform:{'<font color="{COLOR}">{SELTEXT}</font>':"[color={COLOR}]{SELTEXT}[/color]"}},table:{type:"table",title:CURLANG.table,cols:10,rows:10,cellwidth:20,transform:{"<td>{SELTEXT}</td>":"[td]{SELTEXT}[/td]","<tr>{SELTEXT}</tr>":"[tr]{SELTEXT}[/tr]",'<table class="wbb-table">{SELTEXT}</table>':"[table]{SELTEXT}[/table]"},skipRules:true},fontsize:{type:"select",title:CURLANG.fontsize,options:"fs_verysmall,fs_small,fs_normal,fs_big,fs_verybig"},fontfamily:{type:"select",title:CURLANG.fontfamily,excmd:"fontName",valueBBname:"font",options:[{title:"Arial",exvalue:"Arial"},{title:"Comic Sans MS",exvalue:"Comic Sans MS"},{title:"Courier New",exvalue:"Courier New"},{title:"Georgia",exvalue:"Georgia"},{title:"Lucida Sans Unicode",exvalue:"Lucida Sans Unicode"},{title:"Tahoma",exvalue:"Tahoma"},{title:"Times New Roman",exvalue:"Times New Roman"},{title:"Trebuchet MS",exvalue:"Trebuchet MS"},{title:"Verdana",exvalue:"Verdana"}],transform:{'<font face="{FONT}">{SELTEXT}</font>':"[font={FONT}]{SELTEXT}[/font]"}},smilebox:{type:"smilebox",title:CURLANG.smilebox,buttonHTML:'<span class="fonticon ve-tlb-smilebox1">\uE00b</span>'},justifyleft:{title:CURLANG.justifyleft,buttonHTML:'<span class="fonticon ve-tlb-textleft1">\uE015</span>',groupkey:"align",transform:{'<p style="text-align:left">{SELTEXT}</p>':"[left]{SELTEXT}[/left]"}},justifyright:{title:CURLANG.justifyright,buttonHTML:'<span class="fonticon ve-tlb-textright1">\uE016</span>',groupkey:"align",transform:{'<p style="text-align:right">{SELTEXT}</p>':"[right]{SELTEXT}[/right]"}},justifycenter:{title:CURLANG.justifycenter,buttonHTML:'<span class="fonticon ve-tlb-textcenter1">\uE014</span>',groupkey:"align",transform:{'<p style="text-align:center">{SELTEXT}</p>':"[center]{SELTEXT}[/center]"}},video:{title:CURLANG.video,buttonHTML:'<span class="fonticon ve-tlb-video1">\uE008</span>',modal:{title:CURLANG.video,width:"600px",tabs:[{title:CURLANG.video,input:[{param:"SRC",title:CURLANG.modal_video_text}]}],onSubmit:function(j,h,g){var f=this.$modal.find('input[name="SRC"]').val();if(f){f=f.replace(/^\s+/,"").replace(/\s+$/,"");}var e;if(f.indexOf("youtu.be")!=-1){e=f.match(/^http[s]*:\/\/youtu\.be\/([a-z0-9_-]+)/i);}else{e=f.match(/^http[s]*:\/\/www\.youtube\.com\/watch\?.*?v=([a-z0-9_-]+)/i);}if(e&&e.length==2){var i=e[1];this.insertAtCursor(this.getCodeByCommand(j,{src:i}));}this.closeModal();this.updateUI();return false;}},transform:{'<iframe src="https://www.youtube.com/embed/{SRC}" width="640" height="480" frameborder="0"></iframe>':"[video type=youtube]{SRC}[/video]"}},fs_verysmall:{title:CURLANG.fs_verysmall,buttonText:"fs1",excmd:"fontSize",exvalue:"1",transform:{'<font size="1">{SELTEXT}</font>':"[size=50]{SELTEXT}[/size]"}},fs_small:{title:CURLANG.fs_small,buttonText:"fs2",excmd:"fontSize",exvalue:"2",transform:{'<font size="2">{SELTEXT}</font>':"[size=85]{SELTEXT}[/size]"}},fs_normal:{title:CURLANG.fs_normal,buttonText:"fs3",excmd:"fontSize",exvalue:"3",transform:{'<font size="3">{SELTEXT}</font>':"[size=100]{SELTEXT}[/size]"}},fs_big:{title:CURLANG.fs_big,buttonText:"fs4",excmd:"fontSize",exvalue:"4",transform:{'<font size="4">{SELTEXT}</font>':"[size=150]{SELTEXT}[/size]"}},fs_verybig:{title:CURLANG.fs_verybig,buttonText:"fs5",excmd:"fontSize",exvalue:"6",transform:{'<font size="6">{SELTEXT}</font>':"[size=200]{SELTEXT}[/size]"}},removeformat:{title:CURLANG.removeFormat,buttonHTML:'<span class="fonticon ve-tlb-removeformat1">\uE00f</span>',excmd:"removeFormat"}},systr:{"<br/>":"\n",'<span class="wbbtab">{SELTEXT}</span>':"   {SELTEXT}"},customRules:{td:[["[td]{SELTEXT}[/td]",{seltext:{rgx:false,attr:false,sel:false}}]],tr:[["[tr]{SELTEXT}[/tr]",{seltext:{rgx:false,attr:false,sel:false}}]],table:[["[table]{SELTEXT}[/table]",{seltext:{rgx:false,attr:false,sel:false}}]]},smileList:[],attrWrap:["src","color","href"]};this.inited=this.options.onlyBBmode;if(!this.options.themePrefix){a("link").each(a.proxy(function(e,g){var f=a(g).get(0).href.match(/(.*\/)(.*)\/wbbtheme\.css.*$/);if(f!==null){this.options.themeName=f[2];this.options.themePrefix=f[1];}},this));}if(typeof(WBBPRESET)!="undefined"){if(WBBPRESET.allButtons){a.each(WBBPRESET.allButtons,a.proxy(function(f,e){if(e.transform&&this.options.allButtons[f]){delete this.options.allButtons[f].transform;}},this));}a.extend(true,this.options,WBBPRESET);}if(b&&b.allButtons){a.each(b.allButtons,a.proxy(function(f,e){if(e.transform&&this.options.allButtons[f]){delete this.options.allButtons[f].transform;}},this));}a.extend(true,this.options,b);this.init();};a.wysibb.prototype={lastid:1,init:function(){a.log("Init",this);this.isMobile=function(b){(/android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|meego.+mobile|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b));}(navigator.userAgent||navigator.vendor||window.opera);if(this.options.onlyBBmode===true){this.options.bbmode=true;}this.controllers=[];this.options.buttons=this.options.buttons.toLowerCase();this.options.buttons=this.options.buttons.split(",");this.options.allButtons._systr={};this.options.allButtons._systr["transform"]=this.options.systr;this.smileFind();this.initTransforms();this.build();this.initModal();if(this.options.hotkeys===true&&!this.isMobile){this.initHotkeys();}if(this.options.smileList&&this.options.smileList.length>0){this.options.smileList.sort(function(d,c){return(c.bbcode.length-d.bbcode.length);});}this.$txtArea.parents("form").bind("submit",a.proxy(function(){this.sync();return true;},this));this.$txtArea.parents("form").find("input[id*='preview'],input[id*='submit'],input[class*='preview'],input[class*='submit'],input[name*='preview'],input[name*='submit']").bind("mousedown",a.proxy(function(){this.sync();setTimeout(a.proxy(function(){if(this.options.bbmode===false){this.$txtArea.removeAttr("wbbsync").val("");}},this),1000);},this));if(this.options.initCallback){this.options.initCallback.call(this);}a.log(this);},initTransforms:function(){a.log("Create rules for transform HTML=>BB");var g=this.options;if(!g.rules){g.rules={};}if(!g.groups){g.groups={};}var p=g.buttons.slice();p.push("_systr");for(var h=0;h<p.length;h++){var f=g.allButtons[p[h]];if(!f){continue;}f.en=true;if(f.simplebbcode&&a.isArray(f.simplebbcode)&&f.simplebbcode.length==2){f.bbcode=f.html=f.simplebbcode[0]+"{SELTEXT}"+f.simplebbcode[1];if(f.transform){delete f.transform;}if(f.modal){delete f.modal;}}if(f.type=="select"&&typeof(f.options)=="string"){var r=f.options.split(",");a.each(r,function(o,t){if(a.inArray(t,p)==-1){p.push(t);}});}if(f.transform&&f.skipRules!==true){var b=a.extend({},f.transform);for(var q in b){var k=q;var n=b[q];if(!f.bbSelector){f.bbSelector=[];}if(a.inArray(n,f.bbSelector)==-1){f.bbSelector.push(n);}if(this.options.onlyBBmode===false){q=this.wrapAttrs(q);var c=a(document.createElement("DIV")).append(a(this.elFromString(q,document)));var l=this.filterByNode(c.children());if(l=="div"||typeof(g.rules[l])!="undefined"){a.log("create unique selector: "+l);this.setUID(c.children());l=this.filterByNode(c.children());a.log("New rootSelector: "+l);var j=c.html();j=this.unwrapAttrs(j);var s=this.unwrapAttrs(q);f.transform[j]=n;delete f.transform[s];q=j;k=j;}if(!f.excmd){if(!f.rootSelector){f.rootSelector=[];}f.rootSelector.push(l);}if(typeof(g.rules[l])=="undefined"){g.rules[l]=[];}var i={};if(q.match(/\{\S+?\}/)){c.find("*").each(a.proxy(function(t,v){var u=this.getAttributeList(v);a.each(u,a.proxy(function(y,B){var w=a(v).attr(B);if(B.substr(0,1)=="_"){B=B.substr(1);}var A=w.match(/\{\S+?\}/g);if(A){for(var x=0;x<A.length;x++){var z=A[x].substr(1,A[x].length-2);z=z.replace(this.getValidationRGX(z),"");var C=this.relFilterByNode(v,l);var D=(w!=A[x])?this.getRegexpReplace(w,A[x]):false;i[z.toLowerCase()]={sel:(C)?a.trim(C):false,attr:B,rgx:D};}}},this));var o=[];if(!a(v).is("iframe")){a(v).contents().filter(function(){return this.nodeType===3;}).each(a.proxy(function(D,H){var E=H.textContent||H.data;if(typeof(E)=="undefined"){return true;}var w=E.match(/\{\S+?\}/g);if(w){for(var G=0;G<w.length;G++){var B=w[G].substr(1,w[G].length-2);B=B.replace(this.getValidationRGX(B),"");var z=this.relFilterByNode(v,l);var F=(E!=w[G])?this.getRegexpReplace(E,w[G]):false;var A=(z)?a.trim(z):false;if(a.inArray(A,o)>-1||a(H).parent().contents().size()>1){var x=a("<span>").html("{"+B+"}");this.setUID(x,"wbb");var y=(E.indexOf(B)+B.length)+1;var C=E.substr(y,E.length-y);H.data=E.substr(0,E.indexOf(B)-1);a(H).after(this.elFromString(C,document)).after(x);A=((A)?A+" ":"")+this.filterByNode(x);F=false;}i[B.toLowerCase()]={sel:A,attr:false,rgx:F};o[o.length]=A;}}},this));}o=null;},this));var m=c.html();m=this.unwrapAttrs(m);if(k!=m){delete f.transform[k];f.transform[m]=n;q=m;}}g.rules[l].push([n,i]);if(f.onlyClearText===true){if(!this.cleartext){this.cleartext={};}this.cleartext[l]=p[h];}if(f.groupkey){if(!g.groups[f.groupkey]){g.groups[f.groupkey]=[];}g.groups[f.groupkey].push(l);}}}if(f.rootSelector){this.sortArray(f.rootSelector,-1);}var e=a.map(f.transform,function(t,o){return o;}).sort(function(t,o){return((o[0]||"").length-(t[0]||"").length);});f.bbcode=f.transform[e[0]];f.html=e[0];}}this.options.btnlist=p;a.extend(g.rules,this.options.customRules);g.srules={};if(this.options.smileList){a.each(g.smileList,a.proxy(function(o,v){var u=a(this.strf(v.img,g));var t=this.filterByNode(u);g.srules[t]=[v.bbcode,v.img];},this));}for(var d in g.rules){this.options.rules[d].sort(function(t,o){return(o[0].length-t[0].length);});}this.rsellist=[];for(var d in this.options.rules){this.rsellist.push(d);}this.sortArray(this.rsellist,-1);},build:function(){a.log("Build editor");this.$editor=a("<div>").addClass("wysibb");if(this.isMobile){this.$editor.addClass("wysibb-mobile");}if(this.options.direction){this.$editor.css("direction",this.options.direction);}this.$editor.insertAfter(this.txtArea).append(this.txtArea);this.startHeight=this.$txtArea.outerHeight();this.$txtArea.addClass("wysibb-texarea");this.buildToolbar();this.$txtArea.wrap('<div class="wysibb-text">');if(this.options.onlyBBmode===false){var c=this.options.minheight||this.$txtArea.outerHeight();var f=this.options.resize_maxheight;var b=(this.options.autoresize===true)?this.options.resize_maxheight:c;this.$body=a(this.strf('<div class="wysibb-text-editor" style="max-height:{maxheight}px;min-height:{height}px"></div>',{maxheight:b,height:c})).insertAfter(this.$txtArea);this.body=this.$body[0];this.$txtArea.hide();if(c>32){this.$toolbar.css("max-height",c);}a.log("WysiBB loaded");this.$body.addClass("wysibb-body").addClass(this.options.bodyClass);if(this.options.direction){this.$body.css("direction",this.options.direction);}if("contentEditable" in this.body){this.body.contentEditable=true;try{document.execCommand("StyleWithCSS",false,false);this.$body.append("<span></span>");}catch(d){}}else{this.options.onlyBBmode=this.options.bbmode=true;}if(this.txtArea.value.length>0){this.txtAreaInitContent();}this.$body.bind("keydown",a.proxy(function(g){if((g.which==86&&(g.ctrlKey==true||g.metaKey==true))||(g.which==45&&(g.shiftKey==true||g.metaKey==true))){if(!this.$pasteBlock){this.saveRange();this.$pasteBlock=a(this.elFromString('<div style="opacity:0;" contenteditable="true">\uFEFF</div>'));this.$pasteBlock.appendTo(this.body);setTimeout(a.proxy(function(){this.clearPaste(this.$pasteBlock);var e="<span>"+this.$pasteBlock.html()+"</span>";this.$body.attr("contentEditable","true");this.$pasteBlock.blur().remove();this.body.focus();if(this.cleartext){a.log("Check if paste to clearText Block");if(this.isInClearTextBlock()){e=this.toBB(e).replace(/\n/g,"<br/>").replace(/\s{3}/g,'<span class="wbbtab"></span>');}}e=e.replace(/\t/g,'<span class="wbbtab"></span>');this.selectRange(this.lastRange);this.insertAtCursor(e,false);this.lastRange=false;this.$pasteBlock=false;},this),1);this.selectNode(this.$pasteBlock[0]);}return true;}},this));this.$body.bind("keydown",a.proxy(function(h){if(h.which==13){var g=this.isContain(this.getSelectNode(),"li");if(!g){if(h.preventDefault){h.preventDefault();}this.checkForLastBR(this.getSelectNode());this.insertAtCursor("<br/>",false);}}},this));if(this.options.tabInsert===true){this.$body.bind("keydown",a.proxy(this.pressTab,this));}this.$body.bind("mouseup keyup",a.proxy(this.updateUI,this));this.$body.bind("mousedown",a.proxy(function(g){this.clearLastRange();this.checkForLastBR(g.target);},this));if(this.options.traceTextarea===true){a(document).bind("mousedown",a.proxy(this.traceTextareaEvent,this));this.$txtArea.val("");}if(this.options.hotkeys===true){this.$body.bind("keydown",a.proxy(this.presskey,this));}if(this.options.smileConversion===true){this.$body.bind("keyup",a.proxy(this.smileConversion,this));}this.inited=true;if(this.options.autoresize===true){this.$bresize=a(this.elFromString('<div class="bottom-resize-line"></div>')).appendTo(this.$editor).wdrag({scope:this,axisY:true,height:c});}this.imgListeners();}this.$txtArea.bind("mouseup keyup",a.proxy(function(){clearTimeout(this.uitimer);this.uitimer=setTimeout(a.proxy(this.updateUI,this),100);},this));if(this.options.hotkeys===true){a(document).bind("keydown",a.proxy(this.presskey,this));}},buildToolbar:function(){if(this.options.toolbar===false){return false;}this.$toolbar=a("<div>").addClass("wysibb-toolbar").prependTo(this.$editor);var b;a.each(this.options.buttons,a.proxy(function(e,f){var d=this.options.allButtons[f];if(e==0||f=="|"||f=="-"){if(f=="-"){this.$toolbar.append("<div>");}b=a('<div class="wysibb-toolbar-container">').appendTo(this.$toolbar);}if(d){if(d.type=="colorpicker"){this.buildColorpicker(b,f,d);}else{if(d.type=="table"){this.buildTablepicker(b,f,d);}else{if(d.type=="select"){this.buildSelect(b,f,d);}else{if(d.type=="smilebox"){this.buildSmilebox(b,f,d);}else{this.buildButton(b,f,d);}}}}}},this));this.$toolbar.find(".btn-tooltip").hover(function(){a(this).parent().css("overflow","hidden");},function(){a(this).parent().css("overflow","visible");});var c=a(document.createElement("div")).addClass("wysibb-toolbar-container modeSwitch").html('<div class="wysibb-toolbar-btn mswitch" unselectable="on"><span class="btn-inner modesw" unselectable="on">[bbcode]</span></div>').appendTo(this.$toolbar);if(this.options.bbmode==true){c.children(".wysibb-toolbar-btn").addClass("on");}if(this.options.onlyBBmode===false){c.children(".wysibb-toolbar-btn").click(a.proxy(function(d){a(d.currentTarget).toggleClass("on");this.modeSwitch();},this));}},buildButton:function(c,g,d){if(typeof(c)!="object"){c=this.$toolbar;}var f=(d.buttonHTML)?a(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',{text:d.buttonText.replace(/</g,"&lt;")});var b=(this.options.hotkeys===true&&this.options.showHotkeys===true&&d.hotkey)?(' <span class="tthotkey">['+d.hotkey+"]</span>"):"";var e=a('<div class="wysibb-toolbar-btn wbb-'+g+'">').appendTo(c).append(f).append(this.strf('<span class="btn-tooltip">{title}<ins/>{hotkey}</span>',{title:d.title,hotkey:b}));this.controllers.push(e);e.bind("queryState",a.proxy(function(h){(this.queryState(g))?a(h.currentTarget).addClass("on"):a(h.currentTarget).removeClass("on");},this));e.mousedown(a.proxy(function(h){h.preventDefault();this.execCommand(g,d.exvalue||false);a(h.currentTarget).trigger("queryState");},this));},buildColorpicker:function(b,c,e){var k=a('<div class="wysibb-toolbar-btn wbb-dropdown wbb-cp">').appendTo(b).append('<div class="ve-tlb-colorpick"><span class="fonticon">\uE010</span><span class="cp-line"></span></div><ins class="fonticon ar">\uE011</ins>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:e.title}));var f=k.find(".cp-line");var h=a('<div class="wbb-list">').appendTo(k);h.append('<div class="nc">'+CURLANG.auto+"</div>");var d=(e.colors)?e.colors.split(","):[];for(var g=0;g<d.length;g++){d[g]=a.trim(d[g]);if(d[g]=="-"){h.append('<span class="pl"></span>');}else{h.append(this.strf('<div class="sc" style="background:{color}" title="{color}"></div>',{color:d[g]}));}}var i=a(document.body).css("color");this.controllers.push(k);k.bind("queryState",a.proxy(function(l){f.css("background-color",i);var j=this.queryState(c,true);if(j){f.css("background-color",(this.options.bbmode)?j.color:j);k.find(".ve-tlb-colorpick span.fonticon").css("color",(this.options.bbmode)?j.color:j);}},this));k.mousedown(a.proxy(function(j){j.preventDefault();this.dropdownclick(".wbb-cp",".wbb-list",j);},this));k.find(".sc").mousedown(a.proxy(function(j){j.preventDefault();this.selectLastRange();var l=a(j.currentTarget).attr("title");this.execCommand(c,l);k.trigger("queryState");},this));k.find(".nc").mousedown(a.proxy(function(j){j.preventDefault();this.selectLastRange();this.execCommand(c,i);k.trigger("queryState");},this));k.mousedown(function(j){if(j.preventDefault){j.preventDefault();}});},buildTablepicker:function(c,d,e){var n=a('<div class="wysibb-toolbar-btn wbb-dropdown wbb-tbl">').appendTo(c).append('<span class="btn-inner fonticon ve-tlb-table1">\uE00e</span><ins class="fonticon ar">\uE011</ins>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:e.title}));var b=a('<div class="wbb-list">').appendTo(n);var k=a("<div>").css({position:"relative","box-sizing":"border-box"}).appendTo(b);var o=e.rows||10;var l=e.cols||10;var m=o*l;k.css("height",(o*e.cellwidth+2)+"px");for(var f=1;f<=l;f++){for(var i=1;i<=o;i++){var g='<div class="tbl-sel" style="width:'+(f*100/l)+"%;height:"+(i*100/o)+"%;z-index:"+(--m)+'" title="'+i+","+f+'"></div>';k.append(g);}}n.find(".tbl-sel").mousedown(a.proxy(function(u){u.preventDefault();var q=a(u.currentTarget).attr("title");var s=q.split(",");var r=(this.options.bbmode)?"[table]":'<table class="wbb-table" cellspacing="5" cellpadding="0">';for(var p=1;p<=s[0];p++){r+=(this.options.bbmode)?" [tr]\n":"<tr>";for(var h=1;h<=s[1];h++){r+=(this.options.bbmode)?"  [td][/td]\n":"<td>\uFEFF</td>";}r+=(this.options.bbmode)?"[/tr]\n":"</tr>";}r+=(this.options.bbmode)?"[/table]":"</table>";this.insertAtCursor(r);},this));n.mousedown(a.proxy(function(h){h.preventDefault();this.dropdownclick(".wbb-tbl",".wbb-list",h);},this));},buildSelect:function(b,d,e){var m=a('<div class="wysibb-toolbar-btn wbb-select wbb-'+d+'">').appendTo(b).append(this.strf('<span class="val">{title}</span><ins class="fonticon sar">\uE012</ins>',e)).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:e.title}));var f=a('<div class="wbb-list">').appendTo(m);var c=m.find("span.val");var n=(a.isArray(e.options))?e.options:e.options.split(",");var l=(this.isMobile)?a("<select>").addClass("wbb-selectbox"):"";for(var j=0;j<n.length;j++){var h=n[j];if(typeof(h)=="string"){var k=this.options.allButtons[h];if(k){if(k.html){a("<span>").addClass("option").attr("oid",h).attr("cmdvalue",k.exvalue).appendTo(f).append(this.strf(k.html,{seltext:k.title}));}else{f.append(this.strf('<span class="option" oid="'+h+'" cmdvalue="'+k.exvalue+'">{title}</span>',k));}if(this.isMobile){l.append(a("<option>").attr("oid",h).attr("cmdvalue",k.exvalue).append(k.title));}}}else{var g={seltext:h.title};g[e.valueBBname]=h.exvalue;a("<span>").addClass("option").attr("oid",d).attr("cmdvalue",h.exvalue).appendTo(f).append(this.strf(e.html,g));if(this.isMobile){l.append(a("<option>").attr("oid",d).attr("cmdvalue",h.exvalue).append(h.exvalue));}}}if(this.isMobile){l.appendTo(b);this.controllers.push(l);l.bind("queryState",a.proxy(function(i){l.find("option").each(a.proxy(function(q,s){var p=a(s);var t=this.queryState(p.attr("oid"),true);var o=p.attr("cmdvalue");if((o&&t==p.attr("cmdvalue"))||(!o&&t)){p.prop("selected",true);return false;}},this));},this));l.change(a.proxy(function(r){r.preventDefault();var p=a(r.currentTarget).find(":selected");var q=p.attr("oid");var i=p.attr("cmdvalue");var o=this.options.allButtons[q];this.execCommand(q,o.exvalue||i||false);a(r.currentTarget).trigger("queryState");},this));}this.controllers.push(m);m.bind("queryState",a.proxy(function(i){c.text(e.title);m.find(".option.selected").removeClass("selected");m.find(".option").each(a.proxy(function(q,s){var p=a(s);var t=this.queryState(p.attr("oid"),true);var o=p.attr("cmdvalue");if((o&&t==p.attr("cmdvalue"))||(!o&&t)){c.text(p.text());p.addClass("selected");return false;}},this));},this));m.mousedown(a.proxy(function(i){i.preventDefault();this.dropdownclick(".wbb-select",".wbb-list",i);},this));m.find(".option").mousedown(a.proxy(function(q){q.preventDefault();var p=a(q.currentTarget).attr("oid");var i=a(q.currentTarget).attr("cmdvalue");var o=this.options.allButtons[p];this.execCommand(p,o.exvalue||i||false);a(q.currentTarget).trigger("queryState");},this));},buildSmilebox:function(b,f,c){if(this.options.smileList&&this.options.smileList.length>0){var d=a(this.strf(c.buttonHTML,c)).addClass("btn-inner");var e=a('<div class="wysibb-toolbar-btn wbb-smilebox wbb-'+f+'">').appendTo(b).append(d).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:c.title}));var g=a('<div class="wbb-list">').appendTo(e);if(a.isArray(this.options.smileList)){a.each(this.options.smileList,a.proxy(function(h,j){a("<span>").addClass("smile").appendTo(g).append(a(this.strf(j.img,this.options)).attr("title",j.title));},this));}e.mousedown(a.proxy(function(h){h.preventDefault();this.dropdownclick(".wbb-smilebox",".wbb-list",h);},this));e.find(".smile").mousedown(a.proxy(function(h){h.preventDefault();this.insertAtCursor((this.options.bbmode)?this.toBB(a(h.currentTarget).html()):a(a(h.currentTarget).html()));},this));}},updateUI:function(b){if(!b||((b.which>=8&&b.which<=46)||b.which>90||b.type=="mouseup")){a.each(this.controllers,a.proxy(function(c,d){d.trigger("queryState");},this));}this.disNonActiveButtons();},initModal:function(){this.$modal=a("#wbbmodal");if(this.$modal.size()==0){a.log("Init modal");this.$modal=a("<div>").attr("id","wbbmodal").prependTo(document.body).html('<div class="wbbm"><div class="wbbm-title"><span class="wbbm-title-text"></span><span class="wbbclose" title="'+CURLANG.close+'">Ã—</span></div><div class="wbbm-content"></div><div class="wbbm-bottom"><button id="wbbm-submit" class="wbb-button">'+CURLANG.save+'</button><button id="wbbm-cancel" class="wbb-cancel-button">'+CURLANG.cancel+'</button><button id="wbbm-remove" class="wbb-remove-button">'+CURLANG.remove+"</button></div></div>").hide();this.$modal.find("#wbbm-cancel,.wbbclose").click(a.proxy(this.closeModal,this));this.$modal.bind("click",a.proxy(function(b){if(a(b.target).parents(".wbbm").size()==0){this.closeModal();}},this));a(document).bind("keydown",a.proxy(this.escModal,this));}},initHotkeys:function(){a.log("initHotkeys");this.hotkeys=[];var b="0123456789       abcdefghijklmnopqrstuvwxyz";a.each(this.options.allButtons,a.proxy(function(g,e){if(e.hotkey){var f=e.hotkey.split("+");if(f&&f.length>=2){var c=0;var d=f.pop();a.each(f,function(j,h){switch(a.trim(h.toLowerCase())){case"ctrl":c+=1;break;case"shift":c+=4;break;case"alt":c+=7;break;}});if(c>0){if(!this.hotkeys["m"+c]){this.hotkeys["m"+c]=[];}this.hotkeys["m"+c]["k"+(b.indexOf(d)+48)]=g;}}}},this));},presskey:function(c){if(c.ctrlKey==true||c.shiftKey==true||c.altKey==true){var b=((c.ctrlKey==true)?1:0)+((c.shiftKey==true)?4:0)+((c.altKey==true)?7:0);if(this.hotkeys["m"+b]&&this.hotkeys["m"+b]["k"+c.which]){this.execCommand(this.hotkeys["m"+b]["k"+c.which],false);c.preventDefault();return false;}}},execCommand:function(g,f){a.log("execCommand: "+g);var e=this.options.allButtons[g];if(e.en!==true){return false;}var d=this.queryState(g,f);var c=this.isInClearTextBlock();if(c&&c!=g){return;}if(e.excmd){if(this.options.bbmode){a.log("Native command in bbmode: "+g);if(d&&e.subInsert!=true){this.wbbRemoveCallback(g,f);}else{var b={};if(e.valueBBname&&f){b[e.valueBBname]=f;}this.insertAtCursor(this.getBBCodeByCommand(g,b));}}else{this.execNativeCommand(e.excmd,f||false);}}else{if(!e.cmd){this.wbbExecCommand.call(this,g,f,d);}else{e.cmd.call(this,g,f,d);}}this.updateUI();},queryState:function(k,f){var h=this.options.allButtons[k];if(h.en!==true){return false;}if(this.options.bbmode){if(h.bbSelector){for(var g=0;g<h.bbSelector.length;g++){var c=this.isBBContain(h.bbSelector[g]);if(c){return this.getParams(c,h.bbSelector[g],c[1]);}}}return false;}else{if(h.excmd){if(f){try{var d=(document.queryCommandValue(h.excmd)+"").replace(/\'/g,"");if(h.excmd=="foreColor"){d=this.rgbToHex(d);}return d;}catch(j){return false;}}else{try{if((h.excmd=="bold"||h.excmd=="italic"||h.excmd=="underline"||h.excmd=="strikeThrough")&&a(this.getSelectNode()).is("img")){return false;}else{if(h.excmd=="underline"&&a(this.getSelectNode()).closest("a").size()>0){return false;}}return document.queryCommandState(h.excmd);}catch(j){return false;}}}else{if(a.isArray(h.rootSelector)){for(var g=0;g<h.rootSelector.length;g++){var l=this.isContain(this.getSelectNode(),h.rootSelector[g]);if(l){return this.getParams(l,h.rootSelector[g]);}}}return false;}}},wbbExecCommand:function(g,e,c){a.log("wbbExecCommand");var d=this.options.allButtons[g];if(d){if(d.modal){if(a.isFunction(d.modal)){d.modal.call(this,g,d.modal,c);}else{this.showModal.call(this,g,d.modal,c);}}else{if(c&&d.subInsert!=true){this.wbbRemoveCallback(g);}else{if(d.groupkey){var f=this.options.groups[d.groupkey];if(f){var b=this.getSelectNode();a.each(f,a.proxy(function(h,l){var k=this.isContain(b,l);if(k){var j=a("<span>").html(k.innerHTML);var m=this.setUID(j);a(k).replaceWith(j);this.selectNode(this.$editor.find("#"+m)[0]);return false;}},this));}}this.wbbInsertCallback(g,e);}}}},wbbInsertCallback:function(e,d){if(typeof(d)!="object"){d={};}a.log("wbbInsertCallback: "+e);var c=this.getCodeByCommand(e,d);this.insertAtCursor(c);if(this.seltextID&&c.indexOf(this.seltextID)!=-1){var b=this.$body.find("#"+this.seltextID)[0];this.selectNode(b);a(b).removeAttr("id");this.seltextID=false;}},wbbRemoveCallback:function(e,b){a.log("wbbRemoveCallback: "+e);var c=this.options.allButtons[e];if(this.options.bbmode){var g=this.getCursorPosBB();var f=0;a.each(c.bbSelector,a.proxy(function(k,j){var l=j.match(/\{[\s\S]+?\}/g);a.each(l,function(m,i){if(i.toLowerCase()=="{seltext}"){f=m;return false;}});var h=this.isBBContain(j);if(h){this.txtArea.value=this.txtArea.value.substr(0,h[1])+this.txtArea.value.substr(h[1],this.txtArea.value.length-h[1]).replace(h[0][0],(b===true)?"":h[0][f+1]);this.setCursorPosBB(h[1]);return false;}},this));}else{var d=this.getSelectNode();a.each(c.rootSelector,a.proxy(function(m,y){var v=this.isContain(d,y);if(!v){return true;}var r=a(v);var q=this.options.rules[y][0][1];if(r.is("span[wbb]")||!r.is("span,font")){if(b===true||(!q||!q.seltext)){this.setCursorByEl(r);r.remove();}else{if(q&&q.seltext&&q.seltext["sel"]){var u=r.find(q.seltext["sel"]).html();if(c.onlyClearText===true){u=this.getHTML(u,true,true);u=u.replace(/\&#123;/g,"{").replace(/\&#125;/g,"}");}r.replaceWith(u);}else{var u=r.html();if(c.onlyClearText===true){u=this.getHTML(u,true);u=u.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&#123;/g,"{").replace(/\&#125;/g,"}");}r.replaceWith(u);}}return false;}else{var h=this.getRange();var o=this.getSelectText();var k=this.getSelectNode();if(o==""){o="\uFEFF";}else{o=this.clearFromSubInsert(o,e);}var p=this.elFromString(o);var l=(window.getSelection)?h.cloneRange():this.body.createTextRange();var x=(window.getSelection)?h.cloneRange():this.body.createTextRange();if(window.getSelection){this.insertAtCursor('<span id="wbbdivide"></span>');var j=r.find("span#wbbdivide").get(0);l.setStart(v.firstChild,0);l.setEndBefore(j);x.setStartAfter(j);x.setEndAfter(v.lastChild);}else{l.moveToElementText(v);x.moveToElementText(v);l.setEndPoint("EndToStart",h);x.setEndPoint("StartToEnd",h);}var n=this.getSelectText(false,l);var w=this.getSelectText(false,x);if(w!=""){var t=r.clone().html(w);r.after(t);}if(b!==true){r.after(p);}if(window.getSelection){r.html(n);if(b!==true){this.selectNode(p);}}else{r.replaceWith(n);}return false;}},this));}},execNativeCommand:function(h,j){this.body.focus();if(h=="insertHTML"&&!window.getSelection){var f=(this.lastRange)?this.lastRange:document.selection.createRange();f.pasteHTML(j);var b=a("<div>").html(j).text();var d=b.indexOf("\uFEFF");if(d>-1){f.moveStart("character",(-1)*(b.length-d));f.select();}this.lastRange=false;}else{if(h=="insertHTML"){var g=this.getSelection();var i=this.elFromString(j);var c=(this.lastRange)?this.lastRange:this.getRange();c.deleteContents();c.insertNode(i);c.collapse(false);g.removeAllRanges();g.addRange(c);}else{if(typeof j=="undefined"){j=false;}if(this.lastRange){a.log("Last range select");this.selectLastRange();}document.execCommand(h,false,j);}}},getCodeByCommand:function(c,b){return(this.options.bbmode)?this.getBBCodeByCommand(c,b):this.getHTMLByCommand(c,b);},getBBCodeByCommand:function(g,f){if(!this.options.allButtons[g]){return"";}if(typeof(f)=="undefined"){f={};}f=this.keysToLower(f);if(!f.seltext){f.seltext=this.getSelectText(true);}var b=this.options.allButtons[g].bbcode;b=b.replace(/\{(.*?)(\[.*?\])*\}/g,function(k,j,h){if(h){var i;if(h){i=new RegExp(h+"+","i");}if(typeof(f[j.toLowerCase()])!="undefined"&&f[j.toLowerCase()].toString().match(i)===null){return"";}}return(typeof(f[j.toLowerCase()])=="undefined")?"":f[j.toLowerCase()];});var d=null,c=0;if(this.options.allButtons[g].transform){var e=[];a.each(this.options.allButtons[g].transform,function(h,i){e.push(i);});e=this.sortArray(e,-1);a.each(e,function(k,h){var m=true,l=0,j={};h=h.replace(/\{(.*?)(\[.*?\])*\}/g,function(q,o,i){var n;o=o.toLowerCase();if(i){n=new RegExp(i+"+","i");}if(typeof(f[o.toLowerCase()])=="undefined"||(i&&f[o.toLowerCase()].toString().match(n)===null)){m=false;}if(typeof(f[o])!="undefined"&&!j[o]){j[o]=1;l++;}return(typeof(f[o.toLowerCase()])=="undefined")?"":f[o.toLowerCase()];});if(m&&(l>c)){d=h;c=l;}});}return d||b;},getHTMLByCommand:function(h,g){if(!this.options.allButtons[h]){return"";}g=this.keysToLower(g);if(typeof(g)=="undefined"){g={};}if(!g.seltext){g.seltext=this.getSelectText(false);if(g.seltext==""){g.seltext="\uFEFF";}else{g.seltext=this.clearFromSubInsert(g.seltext,h);if(this.options.allButtons[h].onlyClearText===true){g.seltext=this.toBB(g.seltext).replace(/\</g,"&lt;").replace(/\n/g,"<br/>").replace(/\s{3}/g,'<span class="wbbtab"></span>');}}}var e="";this.seltextID="wbbid_"+(++this.lastid);if(h!="link"&&h!="img"){g.seltext='<span id="'+this.seltextID+'">'+g.seltext+"</span>";}else{e='<span id="'+this.seltextID+'">\uFEFF</span>';}var c=this.options.allButtons[h].html;c=c.replace(/\{(.*?)(\[.*?\])*\}/g,function(l,k,i){if(i){var j=new RegExp(i+"+","i");if(typeof(g[k.toLowerCase()])!="undefined"&&g[k.toLowerCase()].toString().match(j)===null){return"";}}return(typeof(g[k.toLowerCase()])=="undefined")?"":g[k.toLowerCase()];});var d=null,b=0;if(this.options.allButtons[h].transform){var f=[];a.each(this.options.allButtons[h].transform,function(i,j){f.push(i);});f=this.sortArray(f,-1);a.each(f,function(l,j){var n=true,m=0,k={};j=j.replace(/\{(.*?)(\[.*?\])*\}/g,function(r,q,i){var o;q=q.toLowerCase();if(i){o=new RegExp(i+"+","i");}if(typeof(g[q])=="undefined"||(i&&g[q].toString().match(o)===null)){n=false;}if(typeof(g[q])!="undefined"&&!k[q]){k[q]=1;m++;}return(typeof(g[q])=="undefined")?"":g[q];});if(n&&(m>b)){d=j;b=m;}});}return(d||c)+e;},getSelection:function(){if(window.getSelection){return window.getSelection();}else{if(document.selection){return(this.options.bbmode)?document.selection.createRange():document.selection.createRange();}}},getSelectText:function(c,d){if(c){this.txtArea.focus();if("selectionStart" in this.txtArea){var b=this.txtArea.selectionEnd-this.txtArea.selectionStart;return this.txtArea.value.substr(this.txtArea.selectionStart,b);}else{var e=document.selection.createRange();return e.text;}}else{this.body.focus();if(!d){d=this.getRange();}if(window.getSelection){if(d){return a("<div>").append(d.cloneContents()).html();}}else{return d.htmlText;}}return"";},getRange:function(){if(window.getSelection){var c=this.getSelection();if(c.getRangeAt&&c.rangeCount>0){return c.getRangeAt(0);}else{if(c.anchorNode){var b=(this.options.bbmode)?document.createRange():document.createRange();b.setStart(c.anchorNode,c.anchorOffset);b.setEnd(c.focusNode,c.focusOffset);return b;}}}else{return(this.options.bbmode===true)?document.selection.createRange():document.selection.createRange();}},insertAtCursor:function(e,b){if(typeof(e)!="string"){e=a("<div>").append(e).html();}if((this.options.bbmode&&typeof(b)=="undefined")||b===true){var d=e.replace(/.*(\[\/\S+?\])$/,"$1");var f=this.getCursorPosBB()+((e.indexOf(d)!=-1&&e.match(/\[.*\]/))?e.indexOf(d):e.length);if(document.selection){this.txtArea.focus();this.getSelection().text=e;}else{if(this.txtArea.selectionStart||this.txtArea.selectionStart=="0"){this.txtArea.value=this.txtArea.value.substring(0,this.txtArea.selectionStart)+e+this.txtArea.value.substring(this.txtArea.selectionEnd,this.txtArea.value.length);}}if(f<0){f=0;}this.setCursorPosBB(f);}else{this.execNativeCommand("insertHTML",e);var c=this.getSelectNode();if(!a(c).closest("table,tr,td")){this.splitPrevNext(c);}}},getSelectNode:function(b){this.body.focus();if(!b){b=this.getRange();}if(!b){return this.$body;}var c=(window.getSelection)?b.commonAncestorContainer:b.parentElement();if(a(c).is(".imgWrap")){c=a(c).children("img")[0];}return c;},getCursorPosBB:function(){var d=0;if("selectionStart" in this.txtArea){d=this.txtArea.selectionStart;}else{this.txtArea.focus();var c=this.getRange();var b=document.body.createTextRange();b.moveToElementText(this.txtArea);b.setEndPoint("EndToStart",c);d=b.text.length;}return d;},setCursorPosBB:function(c){if(this.options.bbmode){if(window.getSelection){this.txtArea.selectionStart=c;this.txtArea.selectionEnd=c;}else{var b=this.txtArea.createTextRange();b.collapse(true);b.move("character",c);b.select();}}},selectNode:function(c,b){if(!b){b=this.getRange();}if(!b){return;}if(window.getSelection){var d=this.getSelection();b.selectNodeContents(c);d.removeAllRanges();d.addRange(b);}else{b.moveToElementText(c);b.select();}},selectRange:function(b){if(b){if(!window.getSelection){b.select();}else{var c=this.getSelection();c.removeAllRanges();c.addRange(b);}}},cloneRange:function(b){if(b){if(!window.getSelection){return b.duplicate();}else{return b.cloneRange();}}},getRangeClone:function(){return this.cloneRange(this.getRange());},saveRange:function(){this.setBodyFocus();this.lastRange=this.getRangeClone();},selectLastRange:function(){if(this.lastRange){this.body.focus();this.selectRange(this.lastRange);this.lastRange=false;}},setBodyFocus:function(){a.log("Set focus to WysiBB editor");if(this.options.bbmode){if(!this.$txtArea.is(":focus")){this.$txtArea.focus();}}else{if(!this.$body.is(":focus")){this.$body.focus();}}},clearLastRange:function(){this.lastRange=false;},filterByNode:function(g){var f=a(g);var d=f.get(0).tagName.toLowerCase();var e=d;var c=this.getAttributeList(f.get(0));a.each(c,a.proxy(function(k,m){var j=f.attr(m);if(m.substr(0,1)=="_"){m=m.substr(1,m.length);}if(j&&!j.match(/\{.*?\}/)){if(m=="style"){var j=f.attr(m);var l=j.split(";");a.each(l,function(n,o){if(o&&o.length>0){e+="["+m+'*="'+a.trim(o)+'"]';}});}else{e+="["+m+'="'+j+'"]';}}else{if(j&&m=="style"){var h=j.substr(0,j.indexOf("{"));if(h&&h!=""){var j=j.substr(0,j.indexOf("{"));var l=j.split(";");a.each(l,function(n,o){e+="["+m+'*="'+o+'"]';});}}else{e+="["+m+"]";}}},this));var b=f.parent().children(e).index(f);if(b>0){e+=":eq("+f.index()+")";}return e;},relFilterByNode:function(c,b){var d="";a.each(this.options.attrWrap,function(f,e){b=b.replace("["+e,"[_"+e);});while(c&&c.tagName!="BODY"&&!a(c).is(b)){d=this.filterByNode(c)+" "+d;if(c){c=c.parentNode;}}return d;},getRegexpReplace:function(c,b){c=c.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,"\\$1").replace(/\s+/g,"\\s+").replace(b.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,"\\$1"),"(.+)").replace(/\{\S+?\}/g,".*");return(c);},getBBCode:function(){if(!this.options.rules){return this.$txtArea.val();}if(this.options.bbmode){return this.$txtArea.val();}this.clearEmpty();this.removeLastBodyBR();return this.toBB(this.$body.html());},toBB:function(d){if(!d){return"";}var c=(typeof(d)=="string")?a("<span>").html(d):a(d);c.find("div,blockquote,p").each(function(){if(this.nodeType!=3&&this.lastChild&&this.lastChild.tagName=="BR"){a(this.lastChild).remove();}});if(c.is("div,blockquote,p")&&c[0].nodeType!=3&&c[0].lastChild&&c[0].lastChild.tagName=="BR"){a(c[0].lastChild).remove();}c.find("ul > br, table > br, tr > br").remove();var b="";a.each(this.options.srules,a.proxy(function(e,f){c.find(e).replaceWith(f[0]);},this));c.contents().each(a.proxy(function(n,h){var s=a(h);if(h.nodeType===3){b+=h.data.replace(/\n+/,"").replace(/\t/g,"   ");}else{var f,l=false;for(var m=0;m<this.rsellist.length;m++){var e=this.rsellist[m];if(s&&s.is(e)){var q=this.options.rules[e];for(var n=0;n<q.length;n++){var p=q[n][0];var k=q[n][1];var r=false,g=false,o=false;if(!s.is("br")){p=p.replace(/\n/g,"<br>");}p=p.replace(/\{(.*?)(\[.*?\])*\}/g,a.proxy(function(w,A,z){var v=k[A.toLowerCase()];if(typeof(v)=="undefined"){a.log("Param: {"+A+"} not found in HTML representation.");r=true;}var t=(v.sel)?a(h).find(v.sel):a(h);if(v.attr&&!t.attr(v.attr)){r=true;return A;}var B=(v.attr)?t.attr(v.attr):t.html();if(typeof(B)=="undefined"||B==null){r=true;return A;}var u=v.rgx;if(u&&v.attr=="style"&&u.substr(u.length-1,1)!=";"){u+=";";}if(v.attr=="style"&&B&&B.substr(B.length-1,1)!=";"){B+=";";}var x=(u)?new RegExp(u,""):false;if(x){if(B.match(x)){var j=B.match(x);if(j&&j.length==2){B=j[1];}}else{B="";}}if(v.attr&&r===false){if(v.attr=="style"){g=true;var y="";var i=v.rgx.replace(/^\.\*\?/,"").replace(/\.\*$/,"").replace(/;$/,"");a(t.attr("style").split(";")).each(function(C,D){if(D&&D!=""){if(!D.match(i)){y+=D+";";}}});if(y==""){t.removeAttr("style");}else{t.attr("style",y);}}else{if(v.rgx===false){g=true;o=true;t.removeAttr(v.attr);}}}if(s.is("table,tr,td,font")){g=true;}return B||"";},this));if(r){continue;}if(s.is("img,br,hr")){b+=p;s=null;break;}else{if(g&&!s.attr("notkeep")){if(s.is("table,tr,td")){p=this.fixTableTransform(p);b+=this.toBB(a("<span>").html(p));s=null;}else{s.empty().html("<span>"+p+"</span>");}}else{if(s.is("iframe")){b+=p;}else{s.empty().html(p);b+=this.toBB(s);s=null;}break;}}}}}if(!s||s.is("iframe,img")){return true;}b+=this.toBB(s);}},this));b.replace(/\uFEFF/g,"");return b;},getHTML:function(c,e,d){if(!this.options.bbmode&&!e){return this.$body.html();}if(!d){c=c.replace(/</g,"&lt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;");}c=c.replace(/\[code\]([\s\S]*?)\[\/code\]/g,function(f){f=f.substr("[code]".length,f.length-"[code]".length-"[/code]".length).replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");return"[code]"+f+"[/code]";});a.each(this.options.btnlist,a.proxy(function(g,f){if(f!="|"&&f!="-"){var h=true;if(!this.options.allButtons[f]||!this.options.allButtons[f].transform){return true;}a.each(this.options.allButtons[f].transform,a.proxy(function(k,o){k=k.replace(/\n/g,"");var i=[];o=o.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1");o=o.replace(/\{(.*?)(\\\[.*?\\\])*\}/gi,a.proxy(function(r,q,n){i.push(q);if(n){n=n.replace(/\\/g,"");return"("+n+"*?)";}return"([\\s\\S]*?)";},this));var p=0,m;while((m=(new RegExp(o,"mgi")).exec(c))!=null){if(m){var l={};a.each(i,a.proxy(function(q,n){l[n]=m[q+1];},this));var j=k;j=j.replace(/\{(.*?)(\[.*?\])\}/g,"{$1}");j=this.strf(j,l);c=c.replace(m[0],j);}}},this));}},this));a.each(this.options.systr,function(f,g){g=g.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1").replace(" ","\\s");c=c.replace(new RegExp(g,"g"),f);});var b=a(this.elFromString("<div>"+c+"</div>"));this.getHTMLSmiles(b);return b.html();},getHTMLSmiles:function(b){a(b).contents().filter(function(){return this.nodeType==3;}).each(a.proxy(this.smileRPL,this));},smileRPL:function(b,c){var d=c.data;a.each(this.options.smileList,a.proxy(function(h,j){var g=d.indexOf(j.bbcode);if(g!=-1){var f=d.substring(g+j.bbcode.length,d.length);var e=document.createTextNode(f);c.data=d=c.data.substr(0,g);a(c).after(e).after(this.strf(j.img,this.options));this.getHTMLSmiles(c.parentNode);return false;}this.getHTMLSmiles(c);},this));},setUID:function(c,b){var d="wbbid_"+(++this.lastid);if(c){a(c).attr(b||"id",d);}return d;},keysToLower:function(b){a.each(b,function(d,c){if(d!=d.toLowerCase()){delete b[d];b[d.toLowerCase()]=c;}});return b;},strf:function(c,b){b=this.keysToLower(a.extend({},b));return c.replace(/\{([\w\.]*)\}/g,function(g,d){d=d.toLowerCase();var e=d.split("."),f=b[e.shift().toLowerCase()];a.each(e,function(){f=f[this];});return(f===null||f===undefined)?"":f;});},elFromString:function(c){if(c.indexOf("<")!=-1&&c.indexOf(">")!=-1){var b=document.createElement("SPAN");a(b).html(c);this.setUID(b,"wbb");return(a(b).contents().size()>1)?b:b.firstChild;}else{return document.createTextNode(c);}},isContain:function(b,c){while(b&&!a(b).hasClass("wysibb")){if(a(b).is(c)){return b;}if(b){b=b.parentNode;}else{return null;}}},isBBContain:function(f){var i=this.getCursorPosBB();var d=this.prepareRGX(f);var c=new RegExp(d,"g");var e;var g=0;while((e=c.exec(this.txtArea.value))!=null){var h=this.txtArea.value.indexOf(e[0],g);if(i>h&&i<(h+e[0].length)){return[e,h];}g=h+1;}},prepareRGX:function(b){return b.replace(/(\[|\]|\)|\(|\.|\*|\?|\:|\||\\)/g,"\\$1").replace(/\{.*?\}/g,"([\\s\\S]*?)");},checkForLastBR:function(d){if(!d){c=this.body;}if(d.nodeType==3){d=d.parentNode;}var c=a(d);if(c.is("span[id*='wbbid']")){c=c.parent();}if(this.options.bbmode===false&&c.is("div,blockquote,code")&&c.contents().size()>0){var b=c[0].lastChild;if(!b||(b&&b.tagName!="BR")){c.append("<br/>");}}if(this.$body.contents().size()>0&&this.body.lastChild.tagName!="BR"){this.$body.append("<br/>");}},getAttributeList:function(c){var b=[];a.each(c.attributes,function(e,d){if(d.specified){b.push(d.name);}});return b;},clearFromSubInsert:function(c,d){if(this.options.allButtons[d]&&this.options.allButtons[d].rootSelector){var b=a("<div>").html(c);a.each(this.options.allButtons[d].rootSelector,a.proxy(function(g,h){var e=false;if(typeof(this.options.rules[h][0][1]["seltext"])!="undefined"){e=this.options.rules[h][0][1]["seltext"]["sel"];}var f=true;b.find("*").each(function(){if(a(this).is(h)){if(e&&e.sel){a(this).replaceWith(a(this).find(e.sel.toLowerCase()).html());}else{a(this).replaceWith(a(this).html());}f=false;}});return f;},this));return b.html();}return c;},splitPrevNext:function(b){if(b.nodeType==3){b=b.parentNode;}var c=this.filterByNode(b).replace(/\:eq.*$/g,"");if(a(b.nextSibling).is(c)){a(b).append(a(b.nextSibling).html());a(b.nextSibling).remove();}if(a(b.previousSibling).is(c)){a(b).prepend(a(b.previousSibling).html());a(b.previousSibling).remove();}},modeSwitch:function(){if(this.options.bbmode){this.$body.html(this.getHTML(this.$txtArea.val()));this.$txtArea.hide().removeAttr("wbbsync").val("");this.$body.css("min-height",this.$txtArea.height()).show().focus();}else{this.$txtArea.val(this.getBBCode()).css("min-height",this.$body.height());this.$body.hide();this.$txtArea.show().focus();}this.options.bbmode=!this.options.bbmode;},clearEmpty:function(){this.$body.children().filter(b).remove();function b(){if(!a(this).is("span,font,a,b,i,u,s")){return false;}if(!a(this).hasClass("wbbtab")&&a.trim(a(this).html()).length==0){return true;}else{if(a(this).children().size()>0){a(this).children().filter(b).remove();if(a(this).html().length==0&&this.tagName!="BODY"){return true;}}}}},dropdownclick:function(f,b,d){var c=a(d.currentTarget).closest(f);if(c.hasClass("dis")){return;}if(c.attr("wbbshow")){c.removeAttr("wbbshow");a(document).unbind("mousedown",this.dropdownhandler);if(document){a(document).unbind("mousedown",this.dropdownhandler);}this.lastRange=false;}else{this.saveRange();this.$editor.find("*[wbbshow]").each(function(e,g){a(g).removeClass("on").find(a(g).attr("wbbshow")).hide().end().removeAttr("wbbshow");});c.attr("wbbshow",b);a(document.body).bind("mousedown",a.proxy(function(e){this.dropdownhandler(c,f,b,e);},this));if(this.$body){this.$body.bind("mousedown",a.proxy(function(e){this.dropdownhandler(c,f,b,e);},this));}}c.find(b).toggle();c.toggleClass("on");},dropdownhandler:function(c,f,b,d){if(a(d.target).parents(f).size()==0){c.removeClass("on").find(b).hide();a(document).unbind("mousedown",this.dropdownhandler);if(this.$body){this.$body.unbind("mousedown",this.dropdownhandler);}}},rgbToHex:function(c){if(c.substr(0,1)=="#"){return c;}if(c.indexOf("rgb")==-1){var b=parseInt(c);b=((b&255)<<16)|(b&65280)|((b&16711680)>>>16);return"#"+b.toString(16);}var d=/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(c);return"#"+this.dec2hex(parseInt(d[2]))+this.dec2hex(parseInt(d[3]))+this.dec2hex(parseInt(d[4]));},dec2hex:function(b){if(b>15){return b.toString(16);}else{return"0"+b.toString(16);}},sync:function(){if(this.options.bbmode){this.$body.html(this.getHTML(this.txtArea.value,true));}else{this.$txtArea.attr("wbbsync",1).val(this.getBBCode());}},clearPaste:function(b){var c=a(b);a.each(this.options.rules,a.proxy(function(g,d){var f=c.find(g).attr("wbbkeep",1);if(f.size()>0){var e=d[0][1];a.each(e,function(j,h){if(h.sel){f.find(h.sel).attr("wbbkeep",1);}});}},this));c.find("*[wbbkeep!='1']").each(a.proxy(function(d,e){var f=a(e);if(f.is("div,p")&&(f.children().size()==0||e.lastChild.tagName!="BR")){f.after("<br/>");}},this));c.find("*[wbbkeep]").removeAttr("wbbkeep").removeAttr("style");a.log(c.html());c.html(this.getHTML(this.toBB(c),true));a.log(c.html());},sortArray:function(b,c){b.sort(function(e,d){return(e.length-d.length)*(c||1);});return b;},smileFind:function(){if(this.options.smilefind){var b=a(this.options.smilefind).find("img[alt]");if(b.size()>0){this.options.smileList=[];b.each(a.proxy(function(d,e){var c=a(e);this.options.smileList.push({title:c.attr("title"),bbcode:c.attr("alt"),img:c.removeAttr("alt").removeAttr("title")[0].outerHTML});},this));}}},destroy:function(){this.$editor.replaceWith(this.$txtArea);this.$txtArea.removeClass("wysibb-texarea").show();this.$modal.remove();this.$txtArea.data("wbb",null);},pressTab:function(b){if(b&&b.which==9){if(b.preventDefault){b.preventDefault();}if(this.options.bbmode){this.insertAtCursor("   ",false);}else{this.insertAtCursor('<span class="wbbtab">\uFEFF</span>',false);}}},removeLastBodyBR:function(){if(this.body.lastChild&&this.body.lastChild.nodeType!=3&&this.body.lastChild.tagName=="BR"){this.body.removeChild(this.body.lastChild);this.removeLastBodyBR();}},traceTextareaEvent:function(b){if(a(b.target).closest("div.wysibb").size()==0){if(a(document.activeElement).is("div.wysibb-body")){this.saveRange();}setTimeout(a.proxy(function(){var c=this.$txtArea.val();if(this.options.bbmode===false&&c!=""&&a(b.target).closest("div.wysibb").size()==0&&!this.$txtArea.attr("wbbsync")){this.selectLastRange();this.insertAtCursor(this.getHTML(c,true));this.$txtArea.val("");}if(a(document.activeElement).is("div.wysibb-body")){this.lastRange=false;}},this),100);}},txtAreaInitContent:function(){this.$body.html(this.getHTML(this.txtArea.value,true));},getValidationRGX:function(b){if(b.match(/\[\S+\]/)){return b.replace(/.*(\\*\[\S+\]).*/,"$1");}return"";},smileConversion:function(){if(this.options.smileList&&this.options.smileList.length>0){var b=this.getSelectNode();if(b.nodeType==3){var c=b.data;if(c.length>=2&&!this.isInClearTextBlock(b)&&a(b).parents("a").size()==0){a.each(this.options.srules,a.proxy(function(j,h){var k=h[0];var g=c.indexOf(k);if(g!=-1){var e=c.substring(g+k.length,c.length);var d=document.createTextNode(e);var f=document.createElement("SPAN");b.data=b.data.substr(0,g);a(b).after(d).after(f).after(this.strf(h[1],this.options));this.selectNode(f);return false;}},this));}}}},isInClearTextBlock:function(){if(this.cleartext){var b=false;a.each(this.cleartext,a.proxy(function(c,d){if(this.queryState(d)){b=d;return false;}},this));return b;}return false;},wrapAttrs:function(b){a.each(this.options.attrWrap,function(d,c){b=b.replace(c+'="',"_"+c+'="');});return b;},unwrapAttrs:function(b){a.each(this.options.attrWrap,function(d,c){b=b.replace("_"+c+'="',c+'="');});return b;},disNonActiveButtons:function(){if(this.isInClearTextBlock()){this.$toolbar.find(".wysibb-toolbar-btn:not(.on,.mswitch)").addClass("dis");}else{this.$toolbar.find(".wysibb-toolbar-btn.dis").removeClass("dis");}},setCursorByEl:function(c){var b=document.createTextNode("\uFEFF");a(c).after(b);this.selectNode(b);},imgListeners:function(){a(document).on("mousedown",a.proxy(this.imgEventHandler,this));},imgEventHandler:function(c){var b=a(c.target);if(this.hasWrapedImage&&(b.closest(".wbb-img,#wbbmodal").size()==0||b.hasClass("wbb-cancel-button"))){this.$body.find(".imgWrap ").each(function(){a.log("Removed imgWrap block");a(this).replaceWith(a(this).find("img"));});this.hasWrapedImage=false;this.updateUI();}if(b.is("img")&&b.closest(".wysibb-body").size()>0){b.wrap("<span class='imgWrap'></span>");this.hasWrapedImage=b;this.$body.focus();this.selectNode(b.parent()[0]);}},showModal:function(h,e,c){a.log("showModal: "+h);this.saveRange();var g=this.$modal.find(".wbbm-content").html("");var d=this.$modal.find(".wbbm").removeClass("hastabs");this.$modal.find("span.wbbm-title-text").html(e.title);if(e.tabs&&e.tabs.length>1){d.addClass("hastabs");var b=a('<div class="wbbm-tablist">').appendTo(g).append("<ul>").children("ul");a.each(e.tabs,a.proxy(function(j,k){if(j==0){k.on="on";}b.append(this.strf("<li class=\"{on}\" onClick=\"$(this).parent().find('.on').removeClass('on');$(this).addClass('on');$(this).parents('.wbbm-content').find('.tab-cont').hide();$(this).parents('.wbbm-content').find('.tab"+j+"').show()\">{title}</li>",k));},this));}if(e.width){d.css("width",e.width);}var f=a('<div class="wbbm-cont">').appendTo(g);if(c){d.find("#wbbm-remove").show();}else{d.find("#wbbm-remove").hide();}a.each(e.tabs,a.proxy(function(j,l){var k=a("<div>").addClass("tab-cont tab"+j).attr("tid",j).appendTo(f);if(j>0){k.hide();}if(l.html){k.html(this.strf(l.html,this.options));}else{a.each(l.input,a.proxy(function(i,m){m.value=c[m.param.toLowerCase()];if(m.param.toLowerCase()=="seltext"&&(!m.value||m.value=="")){m.value=this.getSelectText(this.options.bbmode);}if(m.value&&m.value.indexOf("<span id='wbbid")==0&&a(m.value).is("span[id*='wbbid']")){m.value=a(m.value).html();}if(m.type&&m.type=="div"){k.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><div class="inp-text div-modal-text" contenteditable="true" name="{param}">{value}</div></div>',m));}else{k.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><input class="inp-text modal-text" type="text" name="{param}" value="{value}"/></div>',m));}},this));}},this));if(a.isFunction(e.onLoad)){e.onLoad.call(this,h,e,c);}d.find("#wbbm-submit").click(a.proxy(function(){if(a.isFunction(e.onSubmit)){var j=e.onSubmit.call(this,h,e,c);if(j===false){return;}}var k={};var i=true;this.$modal.find(".wbbm-inperr").remove();this.$modal.find(".wbbm-brdred").removeClass("wbbm-brdred");a.each(this.$modal.find(".tab-cont:visible .inp-text"),a.proxy(function(o,p){var q=a(p).parents(".tab-cont").attr("tid");var n=a(p).attr("name").toLowerCase();var m="";if(a(p).is("input,textrea,select")){m=a(p).val();}else{m=a(p).html();}var l=e.tabs[q]["input"][o]["validation"];if(typeof(l)!="undefined"){if(!m.match(new RegExp(l,"i"))){i=false;a(p).after('<span class="wbbm-inperr">'+CURLANG.validation_err+"</span>").addClass("wbbm-brdred");}}k[n]=m;},this));if(i){a.log("Last range: "+this.lastRange);this.selectLastRange();if(c){this.wbbRemoveCallback(h,true);}this.wbbInsertCallback(h,k);this.closeModal();this.updateUI();}},this));d.find("#wbbm-remove").click(a.proxy(function(){this.selectLastRange();this.wbbRemoveCallback(h);this.closeModal();this.updateUI();},this));a(document.body).css("overflow","hidden");if(a("body").height()>a(window).height()){a(document.body).css("padding-right","18px");}this.$modal.show();if(this.isMobile){d.css("margin-top","10px");}else{d.css("margin-top",(a(window).height()-d.outerHeight())/3+"px");}setTimeout(a.proxy(function(){this.$modal.find(".inp-text:visible")[0].focus();},this),10);},escModal:function(b){if(b.which==27){this.closeModal();}},closeModal:function(){a(document.body).css("overflow","auto").css("padding-right","0").unbind("keyup",this.escModal);this.$modal.find("#wbbm-submit,#wbbm-remove").unbind("click");this.$modal.hide();this.lastRange=false;return this;},getParams:function(b,j,e){var d={};if(this.options.bbmode){var i=j.match(/\{[\s\S]+?\}/g);j=this.prepareRGX(j);var f=new RegExp(j,"g");var c=this.txtArea.value;if(e>0){c=c.substr(e,c.length-e);}var g=f.exec(c);if(g){a.each(i,function(k,l){d[l.replace(/\{|\}/g,"").replace(/"/g,"'").toLowerCase()]=g[k+1];});}}else{var h=this.options.rules[j][0][1];a.each(h,a.proxy(function(o,n){var p="";var q=(n.sel!==false)?p=a(b).find(n.sel):a(b);if(n.attr!==false){p=q.attr(n.attr);}else{p=q.html();}if(p){if(n.rgx!==false){var l=p.match(new RegExp(n.rgx));if(l&&l.length==2){p=l[1];}}d[o]=p.replace(/"/g,"'");}},this));}return d;},imgLoadModal:function(){a.log("imgLoadModal");if(this.options.imgupload===true){this.$modal.find("#imguploader").dragfileupload({url:this.strf(this.options.img_uploadurl,this.options),extraParams:{maxwidth:this.options.img_maxwidth,maxheight:this.options.img_maxheight},themePrefix:this.options.themePrefix,themeName:this.options.themeName,success:a.proxy(function(b){this.$txtArea.insertImage(b.image_link,b.thumb_link);this.closeModal();this.updateUI();},this)});this.$modal.find("#fileupl").bind("change",function(){a("#fupform").submit();});this.$modal.find("#fupform").bind("submit",a.proxy(function(b){a(b.target).parents("#imguploader").hide().after('<div class="loader"><img src="'+this.options.themePrefix+"/"+this.options.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>").parent().css("text-align","center");},this));}else{this.$modal.find(".hastabs").removeClass("hastabs");this.$modal.find("#imguploader").parents(".tab-cont").remove();this.$modal.find(".wbbm-tablist").remove();}},imgSubmitModal:function(){a.log("imgSubmitModal");},printObjectInIE:function(c){try{a.log(JSON.stringify(c));}catch(b){}},checkFilter:function(c,b){a.log("node: "+a(c).get(0).outerHTML+" filter: "+b+" res: "+a(c).is(b.toLowerCase()));},debug:function(c){if(this.options.debug===true){var b=(new Date()).getTime();if(typeof(console)!="undefined"){console.log((b-this.startTime)+" ms: "+c);}else{a("#exlog").append("<p>"+(b-this.startTime)+" ms: "+c+"</p>");}this.startTime=b;}},isChrome:function(){return(window.chrome)?true:false;},fixTableTransform:function(b){if(!b){return"";}if(a.inArray("table",this.options.buttons)==-1){return b.replace(/\<(\/*?(table|tr|td|tbody))[^>]*\>/ig,"");}else{return b.replace(/\<(\/*?(table|tr|td))[^>]*\>/ig,"[$1]".toLowerCase()).replace(/\<\/*tbody[^>]*\>/ig,"");}}};a.log=function(b){if(typeof(wbbdebug)!="undefined"&&wbbdebug===true){if(typeof(console)!="undefined"){console.log(b);}else{a("#exlog").append("<p>"+b+"</p>");}}};a.fn.wysibb=function(b){return this.each(function(){var c=a(this).data("wbb");if(!c){new a.wysibb(this,b);}});};a.fn.wdrag=function(b){if(!b.scope){b.scope=this;}var d={x:0,y:0,height:0};var c;b.scope.drag_mousedown=function(f){f.preventDefault();d={x:f.pageX,y:f.pageY,height:b.height,sheight:b.scope.$body.height()};c=true;a(document).bind("mousemove",a.proxy(b.scope.drag_mousemove,this));a(this).addClass("drag");};b.scope.drag_mouseup=function(f){if(c===true){f.preventDefault();a(document).unbind("mousemove",b.scope.drag_mousemove);a(this).removeClass("drag");c=false;}};b.scope.drag_mousemove=function(h){h.preventDefault();var i=0,g=0;if(b.axisX){i=h.pageX-d.x;}if(b.axisY){g=h.pageY-d.y;}if(g!=0){var f=d.sheight+g;if(f>d.height&&f<=b.scope.options.resize_maxheight){if(b.scope.options.bbmode==true){b.scope.$txtArea.css((b.scope.options.autoresize===true)?"min-height":"height",f+"px");}else{b.scope.$body.css((b.scope.options.autoresize===true)?"min-height":"height",f+"px");}}}};a(this).bind("mousedown",b.scope.drag_mousedown);a(document).bind("mouseup",a.proxy(b.scope.drag_mouseup,this));},a.fn.getDoc=function(){return this.data("wbb").doc;};a.fn.getSelectText=function(b){return this.data("wbb").getSelectText(b);};a.fn.bbcode=function(b){if(typeof(b)!="undefined"){if(this.data("wbb").options.bbmode){this.data("wbb").$txtArea.val(b);}else{this.data("wbb").$body.html(this.data("wbb").getHTML(b));}return this;}else{return this.data("wbb").getBBCode();}};a.fn.htmlcode=function(b){if(!this.data("wbb").options.onlyBBMode&&this.data("wbb").inited===true){if(typeof(b)!="undefined"){this.data("wbb").$body.html(b);return this;}else{return this.data("wbb").getHTML(this.data("wbb").$txtArea.val());}}};a.fn.getBBCode=function(){return this.data("wbb").getBBCode();};a.fn.getHTML=function(){var b=this.data("wbb");return b.getHTML(b.$txtArea.val());};a.fn.getHTMLByCommand=function(c,b){return this.data("wbb").getHTMLByCommand(c,b);};a.fn.getBBCodeByCommand=function(c,b){return this.data("wbb").getBBCodeByCommand(c,b);};a.fn.insertAtCursor=function(c,b){this.data("wbb").insertAtCursor(c,b);return this.data("wbb");};a.fn.execCommand=function(c,b){this.data("wbb").execCommand(c,b);return this.data("wbb");};a.fn.insertImage=function(c,b){var d=this.data("wbb");var e=(b)?d.getCodeByCommand("link",{url:c,seltext:d.getCodeByCommand("img",{src:b})}):d.getCodeByCommand("img",{src:c});this.insertAtCursor(e);return d;};a.fn.sync=function(){this.data("wbb").sync();return this.data("wbb");};a.fn.destroy=function(){this.data("wbb").destroy();};a.fn.queryState=function(b){return this.data("wbb").queryState(b);};})(jQuery);(function(b){b.fn.dragfileupload=function(c){return this.each(function(){var d=new a(this,c);d.init();});};function a(d,c){this.$block=b(d);this.opt=b.extend({url:false,success:false,extraParams:false,fileParam:"img",validation:".(jpg|png|gif|jpeg)$",t1:CURLANG.fileupload_text1,t2:CURLANG.fileupload_text2},c);}a.prototype={init:function(){if(window.FormData!=null){this.$block.addClass("drag");this.$block.prepend('<div class="p2">'+this.opt.t2+"</div>");this.$block.prepend('<div class="p">'+this.opt.t1+"</div>");this.$block.bind("dragover",function(){b(this).addClass("dragover");return false;});this.$block.bind("dragleave",function(){b(this).removeClass("dragover");return false;});var d=b.proxy(function(g){var f=parseInt(g.loaded/g.total*100,10);this.$loader.children("span").text(CURLANG.loading+": "+f+"%");},this);var c=jQuery.ajaxSettings.xhr();if(c.upload){c.upload.addEventListener("progress",d,false);}this.$block[0].ondrop=b.proxy(function(h){h.preventDefault();this.$block.removeClass("dragover");var g=h.dataTransfer.files[0];if(this.opt.validation&&!g.name.match(new RegExp(this.opt.validation))){this.error(CURLANG.validation_err);return false;}var f=new FormData();f.append(this.opt.fileParam,g);if(this.opt.extraParams){b.each(this.opt.extraParams,function(i,e){f.append(i,e);});}this.$loader=b('<div class="loader"><img src="'+this.opt.themePrefix+"/"+this.opt.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>");this.$block.html(this.$loader);b.ajax({type:"POST",url:this.opt.url,data:f,processData:false,contentType:false,xhr:function(){return c;},dataType:"json",success:b.proxy(function(e){if(e&&e.status==1){this.opt.success(e);}else{this.error(e.msg||CURLANG.error_onupload);}},this),error:b.proxy(function(j,e,i){this.error(CURLANG.error_onupload);},this)});},this);}},error:function(c){this.$block.find(".upl-error").remove().end().append('<span class="upl-error">'+c+"</span>").addClass("wbbm-brdred");}};})(jQuery);