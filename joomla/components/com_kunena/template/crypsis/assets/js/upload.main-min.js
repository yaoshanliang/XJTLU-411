jQuery(function(f){f.widget("blueimp.fileupload",f.blueimp.fileupload,{options:{imageMaxWidth:Joomla.getOptions("com_kunena.imagewidth"),imageMaxHeight:Joomla.getOptions("com_kunena.imageheight")}});function d(i,h,j){var k=f("#editor").val();f("#editor").insertAtCaret(" [attachment="+i+"]"+h+"[/attachment]");if(j!==undefined){j.removeClass("btn-primary");j.addClass("btn-success");j.html(Joomla.getOptions("com_kunena.icons.upload")+" "+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));}}jQuery.fn.extend({insertAtCaret:function(h){return this.each(function(l){if(document.selection){this.focus();sel=document.selection.createRange();sel.text=h;this.focus();}else{if(this.selectionStart||this.selectionStart==="0"){var k=this.selectionStart;var j=this.selectionEnd;var m=this.scrollTop;this.value=this.value.substring(0,k)+h+this.value.substring(j,this.value.length);this.focus();this.selectionStart=k+h.length;this.selectionEnd=k+h.length;this.scrollTop=m;}else{this.value+=h;this.focus();}}});}});var g=null;var c=null;var b=0;f("#remove-all").on("click",function(k){k.preventDefault();f("#progress").hide();f("#insert-all").removeClass("btn-success");f("#insert-all").addClass("btn-primary");f("#insert-all").html(Joomla.getOptions("com_kunena.icons.upload")+" "+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_INSERT_ALL_BUTTON"));f("#remove-all").hide();f("#insert-all").hide();var h=f("#editor").val();if(f.isEmptyObject(c)===false){var j=[];f(c).each(function(m,n){if(f("#kattachs-"+n.id).length===0){f("#kattach-list").append('<input id="kattachs-'+n.id+'" type="hidden" name="attachments['+n.id+']" value="1" />');}if(f("#kattach-"+n.id).length>0){f("#kattach-"+n.id).remove();}j.push(n.id);});f.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&files_id_delete="+j+"&editor_text="+h,type:"POST"}).done(function(m){f("#files").empty();if(m.text_prepared!==false){f("#editor").val(m.text_prepared);}}).fail(function(){});c=null;}var l=f("#kattach-list").find("input");var i=[];l.each(function(m,n){var o=f(n);if(!o.attr("id").match("[a-z]{8}")){var p=o.attr("id").match("[0-9]{1,8}");if(f("#kattachs-"+p).length===0){f("#kattach-list").append('<input id="kattachs-'+p+'" type="hidden" name="attachments['+p+']" value="1" />');}if(f("#kattach-"+p).length>0){f("#kattach-"+p).remove();}i.push(p);}});if(i.length!==0){f.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&files_id_delete="+i+"&editor_text="+h,type:"POST"}).done(function(m){f("#files").empty();if(m.text_prepared!==false){f("#editor").val(m.text_prepared);}}).fail(function(){});}f("#alert_max_file").remove();g=0;});f("#insert-all").on("click",function(i){i.preventDefault();var k=f("#kattach-list").find("input");var j=[];k.each(function(n,o){var p=f(o);if(!p.attr("id").match("[a-z]{8}")){var m=p.attr("id").match("[0-9]{1,8}");var l=p.attr("placeholder");d(m,l);f("#insert-all").removeClass("btn-primary");f("#insert-all").addClass("btn-success");f("#insert-all").html(Joomla.getOptions("com_kunena.icons.upload")+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));j.push(m);}});if(f.isEmptyObject(c)===false){var h=[];f(c).each(function(l,m){if(m.inline!==true){d(m.id,m.name);j.push(m.id);}});}f("#files .btn.btn-primary").each(function(){f("#files .btn.btn-primary").addClass("btn-success");f("#files .btn.btn-success").removeClass("btn-primary");f("#files .btn.btn-success").html(Joomla.getOptions("com_kunena.icons.upload")+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));});f.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_set_inline")+"&files_id="+j,type:"POST"}).done(function(l){}).fail(function(){});c=null;});var a=f("<button>").addClass("btn btn-primary").html(Joomla.getOptions("com_kunena.icons.upload")+" "+Joomla.JText._("COM_KUNENA_EDITOR_INSERT")).on("click",function(l){l.preventDefault();l.stopPropagation();var k=f(this),j=k.data();var i=0;var h=null;if(j.result!==undefined){i=j.result.data.id;h=j.result.data.filename;}else{i=j.id;h=j.name;}d(i,h,k);f.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_set_inline")+"&files_id="+i,type:"POST"}).done(function(m){}).fail(function(){});});var e=f("<button/>").addClass("btn btn-danger").attr("type","button").html(Joomla.getOptions("com_kunena.icons.trash")+" "+Joomla.JText._("COM_KUNENA_GEN_REMOVE_FILE")).on("click",function(l){l.preventDefault();l.stopPropagation();var k=f(this),j=k.data();f("#klabel_info_drop_browse").show();var i=0;if(j.uploaded===true){if(j.result!==false){i=j.result.data.id;}else{i=j.file_id;}}if(f("#kattachs-"+i).length===0){f("#kattach-list").append('<input id="kattachs-'+i+'" type="hidden" name="attachments['+i+']" value="1" />');}if(f("#kattach-"+i).length>0){f("#kattach-"+i).remove();}g=g-1;if(g==0){f("#insert-all").hide();f("#remove-all").hide();}f("#alert_max_file").remove();var h=f("#editor").val();f.ajax({url:Joomla.getOptions("com_kunena.kunena_upload_files_rem")+"&files_id_delete="+i+"&editor_text="+h,type:"POST"}).done(function(m){k.parent().remove();if(m.text_prepared!==false){f("#editor").val(m.text_prepared);}}).fail(function(){});});f("#fileupload").fileupload({url:f("#kunena_upload_files_url").val(),dataType:"json",autoUpload:true,disableImageResize:/ Android( ?!.*Chrome) |Opera /.test(window.navigator.userAgent),previewMaxWidth:100,previewMaxHeight:100,previewCrop:true}).bind("fileuploadsubmit",function(i,h){var j={};f.each(h.files,function(k,l){j={catid:f("#kunena_upload").val(),filename:l.name,size:l.size,mime:l.type};});h.formData=j;}).bind("fileuploaddrop",function(j,i){f("#form_submit_button").prop("disabled",true);f("#progress").css("display","block");f("#remove-all").show();f("#insert-all").show();f("#kattach_form").show();var h=Object.keys(i.files).length+g;if(h>Joomla.getOptions("com_kunena.kunena_upload_files_maxfiles")){f('<div class="alert alert-danger" id="alert_max_file"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(f("#files"));f("#form_submit_button").prop("disabled",false);return false;}else{g=Object.keys(i.files).length+g;}}).bind("fileuploadchange",function(j,i){f("#form_submit_button").prop("disabled",true);f("#remove-all").show();f("#insert-all").show();var h=Object.keys(i.files).length+g;if(h>Joomla.getOptions("com_kunena.kunena_upload_files_maxfiles")){f('<div class="alert alert-danger" id="alert_max_file"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(f("#files"));f("#form_submit_button").prop("disabled",false);return false;}else{g=Object.keys(i.files).length+g;}}).on("fileuploadadd",function(i,h){f("#progress .bar").css("width","0%");f("#progress").css("display","block");h.context=f("<div/>").appendTo("#files");f.each(h.files,function(j,k){var l=f("<p/>").append(f("<span/>").text(k.name));if(!j){l.append("<br>");}l.appendTo(h.context);});}).on("fileuploadprocessalways",function(l,k){var h=k.index,i=k.files[h],j=f(k.context.children()[h]);if(i.preview){j.prepend("<br>").prepend(i.preview);}if(i.error){j.append("<br>").append(f('<span class="text-danger"/>').text(i.error));}if(h+1===k.files.length){k.context.find("button.btn-primary").text(Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_UPLOAD_BUTTON")).prop("disabled",!!k.files.error);}}).on("fileuploaddone",function(l,k){var i=parseInt(k.loaded/k.total*100,10);f("#progress .bar").css("width",i+"%");var j=f("<a>").attr("target","_blank").prop("href",k.result.location);k.context.find("span").wrap(j);if(k.result.success===true){f("#form_submit_button").prop("disabled",false);f("#kattach-list").append('<input id="kattachs-'+k.result.data.id+'" type="hidden" name="attachments['+k.result.data.id+']" value="1" />');f("#kattach-list").append('<input id="kattach-'+k.result.data.id+'" placeholder="'+k.result.data.filename+'" type="hidden" name="attachment['+k.result.data.id+']" value="1" />');k.uploaded=true;k.context.append(a.clone(true).data(k));if(k.context.find("button").hasClass("btn-danger")){k.context.find("button.btn-danger").remove();}k.context.append(e.clone(true).data(k));}else{if(k.result.message){f("#form_submit_button").prop("disabled",false);k.uploaded=false;k.context.append(e.clone(true).data(k));var h=null;f.each(k.result.data.exceptions,function(n,m){m=f('<div class="alert alert-error"/>').text(m.message);k.context.find("span").append("<br>").append(m);});}}}).on("fileuploadfail",function(i,h){f.each(h.files,function(k,l){var j=f('<span class="text-danger"/>').text(l.error);f(h.context.children()[k]).append("<br>").append(j);});}).prop("disabled",!f.support.fileInput).parent().addClass(f.support.fileInput?undefined:"disabled");if(f("#kmessageid").val()>0){f.ajax({type:"POST",url:Joomla.getOptions("com_kunena.kunena_upload_files_preload"),async:true,dataType:"json",data:{mes_id:f("#kmessageid").val()}}).done(function(h){if(f.isEmptyObject(h.files)===false){g=Object.keys(h.files).length;c=h.files;f(h.files).each(function(j,k){var l="";if(k.image===true){l='<img src="'+k.path+'" width="100" height="100" /><br />';}else{l=Joomla.getOptions("com_kunena.icons.attach")+" <br />";}if(k.inline===true){b=b+1;}var i=f("<div><p>"+l+"<span>"+k.name+"</span><br /></p></div>");h.uploaded=true;h.result=false;h.file_id=k.id;i.append(a.clone(true).data(k));i.append(e.clone(true).data(h));i.appendTo("#files");});if(b==0){f("#insert-all").show();}f("#remove-all").show();}}).fail(function(){});}});